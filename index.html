<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="./icons/favicon.ico">
    <link rel="manifest" href="./manifest.json">
    <link rel="stylesheet" href="./style.css">
    <meta name="theme-color" content="#0099ff">
    <title>Bit√°cora Semanal de Gimnasio - App</title>

</head>
<body>



    <div class="container" style="position:relative;">
        <h1>
            <span id="smart-word">SMART</span>
            <span id="fit-word">FIT ‚ö°Ô∏è Bit√°cora</span>
        </h1>

        <!-- Indicador de conexi√≥n -->
        <div id="online-indicator" style="display: none;" title="Estado de la conexi√≥n">
            <span class="dot"></span>
            <span id="online-text">Verificando...</span>
        </div>
        <div id="config-tab" class="config-perfil-form content-section" style="display: flex; gap: 6px; margin-top: 6px; flex-direction: column;">
            <h2>Mi perfil</h2> 
            <label for="Nombre">Nombre</label>
            <input type="text" id="Nombre" placeholder="Tu nombre aqu√≠">
            <label for="Edad">Edad</label>
            <input type="number" id="Edad" placeholder="Tu edad aqu√≠">
            <label for="sexo">Sexo</label>
            <select id="sexo">
                <option value="" disabled selected>Selecciona tu sexo</option>
                <option value="masculino">Masculino</option>
                <option value="femenino">Femenino</option>
                <option value="otro">Otro</option>
            </select>
            <label for="Altura">Altura</label>
            <input type="number" id="Altura" placeholder="Tu altura en cm aqu√≠">
            <label for="PesoActual">Peso</label>
            <input type="number" id="PesoActual" placeholder="Tu peso en kg aqu√≠">
            <label for="PesoObejtivo">Peso objetivo</label>
            <input type="number" id="PesoObejtivo" placeholder="Tu peso objetivo en kg aqu√≠">
            <label for="objetivo">objetivo</label>
            <textarea type="text" id="objetivo" placeholder="Tu objetivo fitness aqu√≠"></textarea>
            <label for="macros">Macros</label>
            <div id="macros-list"> </div>
            <button id="guardarPerfil-button" class="action-button register-button">Guardar cambios</button>
            <button class="action-button gemini-button" onclick="descargarRutinaBelcast()" >Descargar rutina Belcast</button>
        </div>
        <div id="registrar-tab" class="content-section">
            <h2>üìù Registrar Sesi√≥n</h2>
            <div class="registro-form">
                <div>
                    <label for="fecha">Fecha y Hora:</label>
                    <input type="text" id="fecha" readonly>
                </div>
                <div>
                    <label for="dia-semana">D√≠a de la Semana:</label>
                    <input type="text" id="dia-semana" readonly>
                </div>
                <div>
                    <label for="comentarios">Detalles / Comentarios:</label>
                    <textarea id="comentarios" rows="5" placeholder="Ej: 3 series de 10 repeticiones en press de banca. Me sent√≠ fuerte."></textarea>
                </div>
                <div style="align-self: flex-end;" id="progreso-global">Progreso: 0%</div>
                <button onclick="registrarSesion()" class="action-button register-button">Guardar Sesi√≥n</button>
            </div>
        </div>

        <div id="planeacion-tab" class="content-section">
                    <h2 style="display: none;" id="planeacion-main-title">üìã Mi Planeaci√≥n Semanal</h2>
                    
                    
        <div style="margin-bottom: 25px;display: none; padding: 15px; border: 1px dashed #ffd700; border-radius: 8px;">
                        <label for="fitness-idol" style="display: block; font-weight: bold; margin-bottom: 10px;">
                            Selecciona tu Inspiraci√≥n Semanal:
                        </label>
                        <select id="fitness-idol" style="width: 100%; padding: 10px; border-radius: 4px; border: 1px solid #555; margin-bottom: 10px; font-size: 16px; background-color: #3a3a3a; color: #e0e0e0;">
                            <option value="" disabled selected>Selecciona un √≠dolo fitness</option>
                            <option value="Carlos Belcast">Carlos Belcast (Fuerza)</option>
                            <option value="Andoni Fitness">Andoni Fitness (Powerbuilding/Fuerza)</option>
                            <option value="Joan Pradells">Joan Pradells (Bodybuilding)</option>
                            <option value="The Saiyan Kiwi">The Saiyan Kiwi (Fuerza/Est√©tica)</option>
                            <option value="Vikika Costa">Vikika Costa (Gl√∫teo/Funcional)</option>
                        </select>
                        
                        <button onclick="descargarRutinaSeleccionada()" id="descarga-btn" class="action-button gemini-button" style="margin-top: 10px;">
                            Descargar Rutina Seleccionada
                        </button>
                    </div>

                    

        <div id="daily-routine-container">
                        <h3 id="current-day-title">Rutina del D√≠a: Cargando...</h3>
                        <div id="daily-routine-content" class="card-grid">
                            <p class="p-message">Cargando rutina o d√≠a de descanso.</p>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px; margin-top: 20px;">
                        <button id="EndTrain" class="action-button register-button">Finalizar entrenamiento</button>
                        <button id="ResetButton"
                        style="background-color: #5d5d5d; color: white;"
                         class="action-button gemini-button">Reiniciar entrenamiento </button>
                    </div>

                    

        <h3 style="margin-top: 30px;">Planeaci√≥n Semanal Resumida</h3>
            <div id="weekly-overview-cards" class="card-grid">
        </div>
            <p id="routine-note" style="margin-top: 20px; font-style: italic; color: #a0a0a0;"></p>
        </div>

        <div id="bitacora-tab" class="content-section active">
                    <h2>üìú Historial de Sesiones</h2>
                    <ul id="bitacora-list" style="color: #e0e0e0;">
                        

        </ul>
                </div>

        <div id="gemini-tab" class="content-section">
                    <h2>‚ú® Dime tu objetivo Fitness</h2>
                    <p>Obt√©n consejos de entrenamiento, nutrici√≥n o informaci√≥n sobre ejercicios espec√≠ficos. ¬°Pregunta lo que necesites!</p>
                    
                    <textarea id="gemini-input" placeholder="Ej: ¬øCu√°les son 3 ejercicios para mejorar la sentadilla profunda?" onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); askGemini(); }"></textarea>
                    <button onclick="askGemini()" class="action-button gemini-button">
                        Enviar Pregunta
                    </button>
                    <div>
                        <div id="propuesta-macros">

                        </div>
                        <button id="aceptar-macros-btn" onclick="" class="action-button gemini-button">
                            Guargar propuesta de macros
                        </button>
                    </div>

                    <h3>Respuesta</h3>
                    
                    <div id="gemini-response-area">
                        <p class="p-message">Las respuestas aparecer√°n aqu√≠. ¬°Preg√∫ntame algo!</p>
                    </div>
                </div>

        <div id="coach-ia-tab" class="content-section">
                    <h2>üß† Coach IA: Generar Rutina R√°pida</h2>
                    <p>Solicita una rutina de ejercicios personalizada para un grupo muscular o enfoque espec√≠fico. Se agregar√° a tu plan del d√≠a.</p>
                    
                    <div>
                        <label for="muscle-group">Grupo Muscular o Enfoque:</label>
                        <input type="text" id="muscle-group" placeholder="Ej: Pecho y Tr√≠ceps, o solo Gl√∫teos">
                    </div>

                    <button onclick="generateRoutine()" class="action-button coach-button">
                        Generar y Agregar a la Rutina de Hoy
                    </button>
                    
                    <h3>Estado</h3>
                    <div id="coach-status-area">
                        <p class="p-message">Ingresa tu enfoque muscular y haz clic en "Generar".</p>
                    </div>
                </div>
            </div>

<nav class="nav-bar">
        <button class="nav-button active" onclick="showTab('registrar-tab', this)">
            <span class="icon">‚úçÔ∏è</span>
            Registrar
        </button>

        <button class="nav-button" onclick="showTab('planeacion-tab', this)">
            <span class="icon">üóìÔ∏è</span>
            Planeaci√≥n
        </button>
        <button class="nav-button" onclick="showTab('bitacora-tab', this)">
            <span class="icon">üìö</span>
            Bit√°cora
        </button>
        <button class="nav-button" onclick="showTab('gemini-tab', this)">
            <span class="icon">‚ú®</span>
            Gemini
        </button>
        <button class="nav-button" onclick="showTab('coach-ia-tab', this)">
            <span class="icon">üß†</span>
            Coach IA
        </button>
                <button class="nav-button active" onclick="showTab('config-tab', this)">
            <span class="icon">‚öôÔ∏è</span>
            Config
        </button>
    </nav>

       <!-- Custom Alert/Confirmation Modal -->
    <div id="custom-modal-overlay" class="modal-overlay" onclick="hideCustomModal()">
        <div id="custom-modal-content" class="modal-content" onclick="event.stopPropagation()">
            <button class="modal-close" onclick="hideCustomModal()">&times;</button>
            <h3 id="modal-title"></h3>
            <p id="modal-message"></p>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; justify-items: center;">
                <button class="action-button modal-confirm-button" onclick="hideCustomModal()">Aceptar</button>
                <button class="action-button modal-cancel-button" onclick="hideCustomModal()">Cancelar</button>

            </div>

        </div>
    </div>

    <div id="edit-routine-modal-overlay" class="modal-overlay " onclick="hideEditRoutineModal()">
        <div id="edit-routine-modal-content" class="modal-content" onclick="event.stopPropagation()">
            
            <button class="modal-close" onclick="hideEditRoutineModal()">&times;</button>
            
            <h3 id="edit-routine-modal-title">Editar Rutina</h3>
            <p id="edit-routine-modal-message">Aqu√≠ puedes editar tu rutina.</p>

            <div id="edit-routine-exercises-container" style="max-height: 400px; overflow-y: auto; margin-top: 15px;">
                <!-- Contenido din√°mico de ejercicios -->
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; justify-items: center;">
                <button class="action-button modal-confirm-button" id="edit-routine-confirm-btn" onclick="confirmEditRoutine()">
                    Guardar cambios
                </button>

                <button class="action-button modal-cancel-button" id="edit-routine-cancel-btn" onclick="hideEditRoutineModal()">
                    Cancelar
                </button>
            </div>

        </div>
    </div>
    
    <script src="app.js"></script>
    <script src="rutinas.js"></script>
    <script>

        if ("serviceWorker" in navigator) {
            navigator.serviceWorker.register("./service-worker.js");
        }

        document.getElementById('guardarPerfil-button').addEventListener('click', function() {
            const nombre = document.getElementById('Nombre').value;
            const edad = document.getElementById('Edad').value;
            const sexo = document.getElementById('sexo').value;
            const objetivo = document.getElementById('objetivo').value;
            const altura = document.getElementById('Altura').value;
            const pesoActual = document.getElementById('PesoActual').value;
            const pesoObjetivo = document.getElementById('PesoObejtivo').value;

            const perfil = {
                nombre: nombre,
                edad: edad,
                sexo: sexo,
                objetivo: objetivo,
                altura: altura,
                pesoActual: pesoActual,
                pesoObjetivo: pesoObjetivo
            };

            localStorage.setItem('perfilUsuario', JSON.stringify(perfil));
            showCustomModal('Perfil Guardado', 'Tu perfil ha sido guardado correctamente.');
        });

        function cargarPeril() {
            const perfilJSON = localStorage.getItem('perfilUsuario');
            

            if (perfilJSON) {
                const perfil = JSON.parse(perfilJSON);
                document.getElementById('Nombre').value = perfil.nombre || '';
                document.getElementById('Edad').value = perfil.edad || '';
                document.getElementById('sexo').value = perfil.sexo || '';
                document.getElementById('objetivo').value = perfil.objetivo || '';
                document.getElementById('Altura').value = perfil.altura || '';
                document.getElementById('PesoActual').value = perfil.pesoActual || '';
                document.getElementById('PesoObejtivo').value = perfil.pesoObjetivo || '';
                if (perfil.macros && perfil.macros.calorias && perfil.macros.proteinas && perfil.macros.carbohidratos && perfil.macros.grasas) {
                const htmloutput = 
                    '<div style="font-family: Arial, sans-serif; padding: 10px; border: 1px solid #ddd; border-radius: 8px; ">' +
                        '<h3 style="color: #007bff; margin-top: 0; border-bottom: 2px solid #007bff; padding-bottom: 5px; margin-bottom: 10px;">üìä Resumen de Macros</h3>' +
                        
                        // Calor√≠as
                        '<p style="margin: 5px 0; font-size: 1.1em;">' +
                            '<strong style="color: #28a745;">üî• Calor√≠as:</strong> ' + perfil.macros.calorias +
                        '</p>' +
                        
                        // Prote√≠nas
                        '<p style="margin: 5px 0;">' +
                            '<strong style="color: #dc3545;">ü•© Prote√≠nas:</strong> ' + perfil.macros.proteinas + 'g' +
                        '</p>' +
                        
                        // Carbohidratos
                        '<p style="margin: 5px 0;">' +
                            '<strong style="color: #ffc107;">üçö Carbohidratos:</strong> ' + perfil.macros.carbohidratos + 'g' +
                        '</p>' +
                        
                        // Grasas
                        '<p style="margin: 5px 0;">' +
                            '<strong style="color: #6f42c1;">ü•ë Grasas:</strong> ' + perfil.macros.grasas + 'g' +
                        '</p>' +
                        
                    '</div>';
                document.getElementById('macros-list').innerHTML = htmloutput || '';
                }

            }
        }
        cargarPeril();

        document.getElementById('ResetButton').addEventListener('click', function() {
        showCustomModal('Reiniciar Entrenamiento', '¬øEst√°s seguro de que deseas reiniciar tu entrenamiento? Esto eliminar√° la rutina actual.', 'confirm', function(confirmed) {
            if (confirmed) {        
                    document.querySelectorAll('input[type="checkbox"]').forEach(c => {
                        c.checked = false;
                    });
                    
                    // Tambi√©n eliminar estados de completion guardados (para evitar datos hu√©rfanos)
                    Object.keys(localStorage)
                        .filter(k => k.startsWith('ROUTINE_COMPLETION_'))
                        .forEach(k => localStorage.removeItem(k));
                    }
                
            });
        });

        // --- CONFIGURACI√ìN Y CONSTANTES ---
                // ...existing code...
        /**
         * Muestra solo la secci√≥n .content-section cuyo id coincida con `idToShow`
         * y oculta el resto.
         * @param {string} idToShow - id del elemento .content-section que debe mostrarse
         */
        function showOnlyContentSectionById(idToShow) {
            const sections = document.querySelectorAll('.content-section');
            sections.forEach(section => {
                if (section.id === idToShow) {
                    section.classList.add('active');
                } else {
                    section.classList.remove('active');
                }
            });
        }

        // ...existing code...
        const STORAGE_KEY = 'bitacoraGymRegistros';
        const ROUTINE_KEY = 'carlosBelcastRoutine';
        
        // Base de la URL para todas las APIs de rutina
        const BASE_API_URL = 'https://studio--studio-9121294900-64a17.us-central1.hosted.app/';
        
        // Mapeo de valores del selector a los endpoints de la API
        const IDOL_ENDPOINTS = {
            "Carlos Belcast": "api/fitness/routines/carlos-belcast",
            "Andoni Fitness": "api/fitness/routines/andoni-fitness/",
            "Joan Pradells": "api/fitness/routines/joan-pradells/",
            "The Saiyan Kiwi": "api/fitness/routines/the-saiyan-kiwi/",
            "Vikika Costa": "api/fitness/routines/vikika-costa/",
        };



        // Funci√≥n auxiliar para fetch con reintentos
        async function exponentialBackoffFetch(url, options, maxRetries = 5) {
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status !== 429 && response.ok) {
                        return response;
                    } else if (response.status === 429 && attempt < maxRetries - 1) {
                        const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        throw new Error(`Error en la API: ${response.statusText}`);
                    }
                } catch (error) {
                    if (attempt === maxRetries - 1) throw error;
                    const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }


        // Funci√≥n de navegaci√≥n: Muestra la pesta√±a seleccionada
        function showTab(tabId, buttonElement) {
            console.log(`Navegando a la pesta√±a: ${tabId}`);
            // Oculta todos los divs de contenido quitando la clase 'active'
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });

            // Muestra el div de contenido seleccionado agregando la clase 'active'
            document.getElementById(tabId).classList.add('active');

            // Actualiza el estado activo de los botones de navegaci√≥n
            document.querySelectorAll('.nav-button').forEach(btn => {
                btn.classList.remove('active');
            });
            buttonElement.classList.add('active');

            // Recargar datos solo si se navega a las pesta√±as de data
            if (tabId === 'bitacora-tab') {
                cargarBitacoraGuardada();
            }
            if (tabId === 'planeacion-tab') {
                const routineData = localStorage.getItem(ROUTINE_KEY);
                if (routineData) {
                    cargarRutinaEnAmbasTablas(JSON.parse(routineData));
                } else {
                    cargarRutinasPorDefecto(); 
                }
            }
            showOnlyContentSectionById(tabId);

            document.querySelectorAll('.content-section').forEach(c => {
                 c.style.display = "none";
            });

            document.getElementById(tabId).style.display = "block";
        }

        // --- Funciones de Bit√°cora y Estado ---

        function cargarFechaYHora() {
            const now = new Date();
            const optionsFecha = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            
            const fechaString = now.toLocaleDateString('es-ES', optionsFecha);
            const diaSemanaString = diasSemana[now.getDay()];

            document.getElementById('fecha').value = fechaString;
            document.getElementById('dia-semana').value = diaSemanaString;
        }

        function renderizarRegistros(registros) {
            const bitacoraList = document.getElementById('bitacora-list');
            bitacoraList.innerHTML = ''; 
            
            if (registros.length === 0) {
                bitacoraList.innerHTML = '<li style="color: #a0a0a0; text-align: center; padding: 20px;"><strong>¬°Empecemos!</strong> A√∫n no tienes sesiones registradas.</li>';
                return;
            }

            // Invertir el orden para mostrar el m√°s reciente primero
            registros.slice().reverse().forEach(registro => {
                const nuevoRegistro = document.createElement('li');
                nuevoRegistro.className = 'bitacora-card';
                
                if (registro.progreso) {
                    // Formatear el contenido de la card
                nuevoRegistro.innerHTML = `
                    <div class="bitacora-header">
                        <p class="day-label">${registro.diaSemana}</p>
                        <p class="">${registro.fecha}</p>
                    </div>
                    <p>${registro.comentarios}</p>
                    <!-- BARRA DE PROGRESO -->
                    <div class="bitacora-progress">
                        <div class="bitacora-progress-fill" style="width: ${registro.progreso}%;" data-percentage="${registro.progreso}%"></div>
                    </div>
                    
                `;
                } else {
                    nuevoRegistro.innerHTML = `
                    <div class="bitacora-header">
                        <p class="day-label">${registro.diaSemana}</p>
                        <p class="">${registro.fecha}</p>
                    </div>
                    <p>${registro.comentarios}</p>
                `;
                }
                
                bitacoraList.appendChild(nuevoRegistro); 
            });
        }


        function cargarBitacoraGuardada() {
            const registrosJSON = localStorage.getItem(STORAGE_KEY);
            let registros = registrosJSON ? JSON.parse(registrosJSON) : [];
            renderizarRegistros(registros);
        }

        function registrarSesion() {
            const fecha = document.getElementById('fecha').value;
            const diaSemana = document.getElementById('dia-semana').value;
            const comentarios = document.getElementById('comentarios').value;
            calcularPorcentaje();
            const progreso = progresoPorcentaje;
            if (progreso === 0 || !comentarios.trim()) {
                let mensaje = "";

                if (progreso === 0) {
                    mensaje += "Parece que no has completado ninguna serie en tu rutina de hoy. ";
                }

                if (!comentarios.trim()) {
                    mensaje += "Por favor, ingresa los detalles de tu sesi√≥n.";
                }

                showCustomModal('Atenci√≥n', mensaje.trim(), 'alert');
                return;
            }
            
            const nuevoRegistro = {
                fecha: fecha,
                diaSemana: diaSemana,
                comentarios: comentarios.trim(),
                progreso: progreso
            };

            const registrosJSON = localStorage.getItem(STORAGE_KEY);
            let registros = registrosJSON ? JSON.parse(registrosJSON) : [];

            registros.push(nuevoRegistro);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(registros));
            
            document.getElementById('comentarios').value = '';
            cargarFechaYHora();

            console.log("¬°Sesi√≥n registrada con √©xito!");
        }

        // --- Funciones de Planeaci√≥n (Descarga y Manejo de Estado) ---
        
        function getCompletionKey(routine) {
            const today = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
            return `ROUTINE_COMPLETION_${today}_${routine.semana || 'Custom'}`;
        }
        var progresoPorcentaje = 0;
        window.toggleSeriesCompletion = function(checkbox, completionKey) {
            let completionState = JSON.parse(localStorage.getItem(completionKey)) || {};
            console.log('Checkbox cambiado:', checkbox);
            const exerciseIndex = checkbox.getAttribute('data-exercise-index');
            const seriesNum = checkbox.getAttribute('data-series-num');
            const uniqueId = `e${exerciseIndex}s${seriesNum}`; // Clave √∫nica simplificada
            
            completionState[uniqueId] = checkbox.checked;

            localStorage.setItem(completionKey, JSON.stringify(completionState));
            console.log('Estado de finalizaci√≥n actualizado:', completionKey);
             calcularPorcentaje();
            //console.log(`Progreso: ${porcentaje}% (${checkedCheckboxes}/${totalCheckboxes})`);
        }

        function calcularPorcentaje() {
               // === Calcular porcentaje de checkboxes marcados ===
            const totalCheckboxes = document.querySelectorAll('[data-exercise-index][data-series-num]').length;
            const checkedCheckboxes = document.querySelectorAll('[data-exercise-index][data-series-num]:checked').length;

            const porcentaje = totalCheckboxes > 0 
                ? Math.round((checkedCheckboxes / totalCheckboxes) * 100)
                : 0;
            progresoPorcentaje = porcentaje;

            if (porcentaje == 100) {
                showCustomModal('¬°Felicidades!', '¬°Has completado toda la rutina del d√≠a. üéâ.!');
            }
                // === Mostrar el porcentaje en pantalla ===
                const etiqueta = document.getElementById('progreso-global');
                if (etiqueta) {
                    etiqueta.textContent = `Progreso: ${porcentaje}%`;
                }
        }
        
        calcularPorcentaje(); // Llamada inicial para mostrar el progreso al cargar

        function cargarRutinaDelDiaModal(diaHoy, routineData) {
            // Mostrar modal con la rutina del d√≠a
            const modalTitle = `Detalles de la Rutina para ${diaHoy}`;
            let modalMessage = '';

            const todayRoutine = routineData.dias.find(d => d.dia.toLowerCase() === diaHoy.toLowerCase());
            
            if (todayRoutine && todayRoutine.ejercicios.length > 0) {
                modalMessage += `<h4>Rutina del D√≠a: ${todayRoutine.dia} (${todayRoutine.enfoque})</h4>`;
                
                todayRoutine.ejercicios.forEach((ej, index) => {
                    modalMessage += `
                        <div style="border: 1px solid #555; padding: 10px; margin-bottom: 10px; border-radius: 8px;">
                            <h4>${ej.nombre}</h4>
                            <p><strong>Series:</strong> ${ej.series} | <strong>Repeticiones:</strong> ${ej.repeticiones}</p>
                        </div>
                    `;
                });

            } else {
                modalMessage = `<p class="p-message">¬°Hoy es d√≠a de descanso o a√∫n no tienes ejercicios! Genera una rutina con el Coach IA o descarga una planeaci√≥n.</p>`;
            }

            showCustomModal(modalTitle, modalMessage, 'info');
            
        }

        // Carga la rutina del d√≠a en el formato de cards con checkboxes
        function cargarRutinaDelDia(diaHoy, routineData) {
            const dailyContent = document.getElementById('daily-routine-content');
            const currentDayTitle = document.getElementById('current-day-title');
            
            const todayRoutine = routineData.dias.find(d => d.dia.toLowerCase() === diaHoy.toLowerCase());
            
            const completionKey = getCompletionKey(routineData);
            let completionState = JSON.parse(localStorage.getItem(completionKey)) || {};

            dailyContent.innerHTML = ''; 

            if (todayRoutine && todayRoutine.ejercicios.length > 0) {
                currentDayTitle.textContent = `Rutina del D√≠a: ${todayRoutine.dia} (${todayRoutine.enfoque})`;
                
                todayRoutine.ejercicios.forEach((ej, index) => {
                    const card = document.createElement('div');
                    card.className = 'exercise-card';
                    
                    let checklistHTML = '<div class="series-checklist">';
                    const numSeries = parseInt(ej.series);

                    for (let i = 1; i <= numSeries; i++) {
                        const uniqueSeriesId = `e${index}s${i}`;
                        const isChecked = completionState[uniqueSeriesId] === true;

                        checklistHTML += `
                            <label for="${uniqueSeriesId}" class="series-item">
                                <input type="checkbox" id="${uniqueSeriesId}" 
                                       data-exercise-index="${index}" 
                                       data-series-num="${i}" 
                                       ${isChecked ? 'checked' : ''} 
                                       onchange="toggleSeriesCompletion(this, '${completionKey}')">
                                <span>Serie ${i}</span>
                            </label>
                        `;
                    }
                    checklistHTML += '</div>';

                    card.innerHTML = `
                        <h4>${ej.nombre}</h4>
                        <p><strong>Series:</strong> ${ej.series} | <strong>Repeticiones:</strong> ${ej.repeticiones}</p>
                        ${checklistHTML}
                    `;
                    dailyContent.appendChild(card);
                });

            } else {
                currentDayTitle.textContent = `Rutina del D√≠a: ${diaHoy} (Descanso o Vac√≠a)`;
                dailyContent.innerHTML = '<p class="p-message">¬°Hoy es d√≠a de descanso o a√∫n no tienes ejercicios! Genera una rutina con el Coach IA o descarga una planeaci√≥n.</p>';
            }
        }

        // Carga la planeaci√≥n semanal resumida
        function cargarPlaneacionSemanal(routineData) {
            const weeklyCardsContainer = document.getElementById('weekly-overview-cards');
            weeklyCardsContainer.innerHTML = ''; 

            const order = ["Lunes", "Martes", "Mi√©rcoles", "Jueves", "Viernes", "S√°bado", "Domingo"];
            const daysMap = new Map();
            
            routineData.dias.forEach(diaData => {
                daysMap.set(diaData.dia, {
                    enfoque: diaData.enfoque,
                    duracion: `${diaData.duracion_sugerida_min || '??'} min`,
                    isRest: false,
                    exerciseCount: diaData.ejercicios.length
                });
            });

            if (routineData.descanso) {
                daysMap.set(routineData.descanso, {
                    enfoque: "D√≠a de Descanso",
                    duracion: "Recuperaci√≥n.",
                    isRest: true,
                    exerciseCount: 0
                });
            }
            
            const today = new Date();
            const diaHoy = diasSemana[today.getDay()];
            
            order.forEach(diaKey => {
                const data = daysMap.get(diaKey);
                
                if (data) {
                    const card = document.createElement('div');
                    let cardClass = 'weekly-card';
                    if (diaKey === diaHoy) {
                        cardClass += ' current-day-highlight';
                    } else if (data.isRest) {
                        cardClass += ' rest-day';
                    }
                    card.className = cardClass;
                    
                    const enfoqueText = data.isRest ? data.enfoque : `Enfoque: ${data.enfoque}`;
                    const exerciseCountText = data.exerciseCount > 0 ? `(${data.exerciseCount} ejercicios)` : '';

                    card.innerHTML = `
                        <h4>${diaKey}</h4>
                        <p><strong>${enfoqueText}</strong> ${exerciseCountText}</p>
                        <p>Duraci√≥n: ${data.duracion}</p>
                        <button class="view-day-button" onclick="showEditRoutineModal('${diaKey}', ${JSON.stringify(routineData).replace(/"/g, '&quot;')})">
                            Ver Detalles </button>
                    `;
                    weeklyCardsContainer.appendChild(card);
                }
            });
        }

        // Carga ambas tablas (la del d√≠a y la semanal)
        function cargarRutinaEnAmbasTablas(routine) {
            const mainTitle = document.getElementById('planeacion-main-title');
            const noteP = document.getElementById('routine-note');

            mainTitle.textContent = `üìã Rutina: ${routine.semana || 'Planeaci√≥n'}`;
            noteP.innerHTML = `**Nota del Entrenador:** ${routine.nota_estilo || 'Rutina personalizada.'}`;

            const today = new Date();
            const diaHoy = diasSemana[today.getDay()];
            
            cargarRutinaDelDia(diaHoy, routine);
            cargarPlaneacionSemanal(routine);
        }
        
        // Carga las rutinas por defecto 
        function cargarRutinasPorDefecto() {
            const defaultRoutine = {
                semana: "Planeaci√≥n Inicial",
                nota_estilo: "Esta es tu planeaci√≥n pre-cargada. Los ejercicios que a√±adas con el Coach IA se guardar√°n aqu√≠.",
                dias: [
                    { dia: "Lunes", enfoque: "Full Body (Descarga una para detalles)", duracion_sugerida_min: 60, ejercicios: [] },
                    { dia: "Martes", enfoque: "Cardio", duracion_sugerida_min: 60, ejercicios: [] },
                    { dia: "Mi√©rcoles", enfoque: "H√≠brido", duracion_sugerida_min: 30, ejercicios: [] },
                    { dia: "Jueves", enfoque: "Pierna/Fuerza", duracion_sugerida_min: 65, ejercicios: [] },
                    { dia: "Viernes", enfoque: "Pecho y Espalda", duracion_sugerida_min: 60, ejercicios: [] },
                    { dia: "S√°bado", enfoque: "Circuito/Deporte", duracion_sugerida_min: 60, ejercicios: [] },
                ],
                descanso: "Domingo"
            };
            localStorage.setItem(ROUTINE_KEY, JSON.stringify(defaultRoutine));
            cargarRutinaEnAmbasTablas(defaultRoutine);
        }


        // Funci√≥n principal para descargar la rutina seleccionada
        async function descargarRutinaSeleccionada() {
            const select = document.getElementById('fitness-idol');
            const selectedIdol = select.value;

            if (!selectedIdol) {
                alert("Por favor, selecciona un √≠dolo fitness de la lista.");
                return;
            }

            const button = document.getElementById('descarga-btn');
            const originalText = button.textContent;
            button.textContent = 'Descargando...';
            button.disabled = true;

            const endpoint = IDOL_ENDPOINTS[selectedIdol];
            const fullUrl = BASE_API_URL + endpoint;
            
            try {
                const response = await fetch(fullUrl);
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status} en la URL: ${fullUrl}`);
                }
                
                const routineData = await response.json();
                
                // A√±adir el nombre del √≠dolo como el nombre de la rutina si no tiene uno
                if (!routineData.semana) {
                    routineData.semana = `Rutina de ${selectedIdol}`;
                }
                console.log('Rutina descargada:', routineData);
                localStorage.setItem(ROUTINE_KEY, JSON.stringify(routineData));
                cargarRutinaEnAmbasTablas(routineData);

                console.log(`Rutina de ${selectedIdol} descargada y cargada con √©xito.`);

            } catch (error) {
                console.error("Error al descargar la rutina:", error);
                alert(`Error al descargar la rutina de ${selectedIdol}. Revisa la consola.`);
            } finally {
                button.textContent = originalText;
                button.disabled = false;
            }
        }
        

        // Configuraci√≥n de la API de Gemini
        const GEMINI_MODEL = 'gemini-2.5-flash-preview-09-2025';
        const GEMINI_API_KEY = "AIzaSyB5bWXrGYzj59xyZEdx_CfcTOOxEyvaQxU"; 
        const GEMINI_BASE_URL = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`;

        const QNA_SYSTEM_INSTRUCTION = "Act√∫a como un entrenador personal y nutricionista amigable y experto. Tu objetivo es proporcionar consejos de fitness, responder preguntas sobre rutinas, ejercicios y nutrici√≥n. Responde siempre de manera concisa y √∫til.";
        
        const ROUTINE_SYSTEM_INSTRUCTION = "Eres un generador de rutinas de fitness profesional. Crea una lista de 3 a 5 ejercicios efectivos para el enfoque muscular solicitado. Para cada ejercicio, proporciona un nombre, el n√∫mero de series sugeridas ('3', '4', etc.) y el rango de repeticiones sugeridas ('8-12', '10-15', etc.). DEBES RESPONDER √öNICAMENTE CON EL ARRAY JSON SOLICITADO, sin texto adicional.";

        // Mapeo de d√≠as de la semana de Date.getDay() a espa√±ol
        const diasSemana = ["Domingo", "Lunes", "Martes", "Mi√©rcoles", "Jueves", "Viernes", "S√°bado"];
        
        // Esquema JSON para la rutina estructurada
        const routineSchema = {
            type: "OBJECT",
            properties: {
                "titulo": {
                    type: "STRING",
                    description: "T√≠tulo general de la rutina debe ser corto, e.g. 'Rutina de Hombro y Abdomen'"
                },
                "rutina": {
                    type: "ARRAY",
                    items: {
                        type: "OBJECT",
                        properties: {
                            "nombre": { "type": "STRING", description: "The name of the exercise, e.g., 'Sentadilla Profunda'." },
                            "series": { "type": "STRING", description: "Number of suggested sets, e.g., '3'." },
                            "repeticiones": { "type": "STRING", description: "Number of suggested reps, e.g., '8-12'." }
                        },
                        required: ["nombre", "series", "repeticiones"],
                        propertyOrdering: ["nombre", "series", "repeticiones"]
                    }
                }
            },
            required: ["titulo", "rutina"],
            propertyOrdering: ["titulo", "rutina"]
        };

        // --- FUNCI√ìN DE INTERACCI√ìN CON GEMINI (Q&A) ---
        async function askGemini() {
    const query = document.getElementById('gemini-input').value.trim();
    const responseArea = document.getElementById('gemini-response-area');
    
    if (!query) {
        responseArea.innerHTML = '<p class="p-message error-message">Por favor, ingresa una pregunta.</p>';
        return;
    }

    responseArea.innerHTML = '<p class="loading-message">Generando respuesta... ‚ú®</p>';
    //document.getElementById('gemini-input').value = ''; 

    // 1. Definir la instrucci√≥n del sistema (Reglas del modelo)
    const systemInstructionText = "Eres un asistente experto en fitness y nutrici√≥n. Responde a las preguntas de manera concisa y √∫til. Y AL FINAL INCLUYE LOS MACRONUTRIENTES Y CALORIAS. ANTES DE ESCRIBIR LOS MACROS INCLUYE LA PALBRA 'MACROSNOMOSTRAR' y apartir de aqui solo dame los macros en formato json con la siguiete estructura {calorias: '', proteinas: '', carbohidratos: '', grasas: ''} SIN NINGUN TEXTO ADICIONAL.";

    // 2. Obtener el perfil del usuario para el historial/consulta (Contexto para la pregunta)
    const perfil = localStorage.getItem('perfilUsuario');
    const perfilTexto = perfil ? `El usuario tiene el siguiente perfil: ${perfil}. ` : '';
    
    // 3. Crear el mensaje de la consulta completa (que incluye el contexto del usuario)
    const fullPrompt = `${perfilTexto}Pregunta del usuario: ${query}`;

    // 4. Estructurar el payload correctamente
    const payload = {
        // La instrucci√≥n del sistema define el rol/tono del modelo
        systemInstruction: { 
            parts: [{ text: systemInstructionText }] 
        },
        // El contenido es el mensaje del usuario (incluyendo el contexto del perfil)
        contents: [{ 
            parts: [{ text: fullPrompt }] 
        }],
        // generationConfig: {
        //             responseMimeType: "application/json",
        //             responseSchema: routineSchema
        //         },
        // Herramientas
        tools: [{ "google_search": {} }], 
    };

    const options = {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    };

    try {
        // ... (El resto del c√≥digo de fetch y manejo de respuesta sigue igual)
        const response = await exponentialBackoffFetch(GEMINI_BASE_URL, options);
        const result = await response.json();
        
        const candidate = result.candidates?.[0];
        
        if (candidate && candidate.content?.parts?.[0]?.text) {
            const text = candidate.content.parts[0].text;
            const textocortado = text.split("MACROSNOMOSTRAR");

            let sources = [];
            const groundingMetadata = candidate.groundingMetadata;

            if (groundingMetadata && groundingMetadata.groundingAttributions) {
                sources = groundingMetadata.groundingAttributions
                    .map(attribution => ({
                        uri: attribution.web?.uri,
                        title: attribution.web?.title,
                    }))
                    .filter(source => source.uri && source.title);
            }

            let outputHTML = `<div>${textocortado[0].replace(/\n/g, '<br>')}</div>`;
            
            if (sources.length > 0) {
                outputHTML += '<h4 style="margin-top: 20px; color: #e0e0e0;">Fuentes:</h4>';
                outputHTML += '<ul class="source-list">';
                sources.forEach(source => {
                    outputHTML += `<li><a href="${source.uri}" target="_blank">${source.title}</a></li>`;
                });
                outputHTML += '</ul>';
            }

           // console.log("Respuesta de Gemini para Q&A (sin macros):", textocortado[0]);
           // console.log("Respuesta de Gemini para Q&A (con macros):", textocortado[1]);
            textocortado[1] = textocortado[1].replace(/'/g, '"'); // Reemplaza comillas simples por dobles
            try {
                const macros = JSON.parse(textocortado[1]);
                macrosPropuestos = macros;
                console.log("Macros parseados:", macros);
                const outputHTML2 = `
                    <h4 style="margin-top: 20px; color: #e0e0e0;">Macros Sugeridos:</h4>
                    <ul class="macros-list">
                        <li><strong>Calor√≠as:</strong> ${macros.calorias}</li>
                        <li><strong>Prote√≠nas:</strong> ${macros.proteinas} g</li>
                        <li><strong>Carbohidratos:</strong> ${macros.carbohidratos} g</li>
                        <li><strong>Grasas:</strong> ${macros.grasas} g</li>
                    </ul>
                `;
                document.getElementById('propuesta-macros').innerHTML = outputHTML2;

            } catch (parseError) {
                console.error("Error al parsear los macros JSON:", parseError);
            }
            responseArea.innerHTML = outputHTML;

        } else {
            responseArea.innerHTML = '<p class="error-message">Error: No se pudo obtener una respuesta v√°lida de Gemini. Int√©ntalo de nuevo.</p>';
        }

    } catch (error) {
        console.error("Error al comunicarse con la API de Gemini:", error);
        responseArea.innerHTML = '<p class="error-message">Ocurri√≥ un error al procesar tu solicitud. Revisa la consola para m√°s detalles.</p>';
    }
}
    var macrosPropuestos = {};
    document.getElementById('aceptar-macros-btn').addEventListener('click', function() {
        if (Object.keys(macrosPropuestos).length === 0) {
            showCustomModal('Atenci√≥n', 'No hay macros propuestos para aceptar. Por favor, realiza una pregunta primero.', 'alert');
            return;
        }

        const perfil = {
            nombre: document.getElementById('Nombre').value || 'Usuario',
            edad: document.getElementById('Edad').value || 'N/A',
            sexo: document.getElementById('sexo').value || 'N/A',
            objetivo: document.getElementById('objetivo').value || 'N/A',
            altura: document.getElementById('Altura').value || 'N/A',
            pesoActual: document.getElementById('PesoActual').value || 'N/A',
            pesoObjetivo: document.getElementById('PesoObejtivo').value || 'N/A',
            macros: macrosPropuestos
        };

        localStorage.setItem('perfilUsuario', JSON.stringify(perfil));
        showCustomModal('Macros Aceptados', 'Los macronutrientes sugeridos han sido guardados en tu perfil.');
    });

// --- FUNCI√ìN DE COACH IA (GENERACI√ìN DE RUTINA ESTRUCTURADA) ---
        async function generateRoutine() {
            const muscleGroup = document.getElementById('muscle-group').value.trim();
            const statusArea = document.getElementById('coach-status-area');
            
            if (!muscleGroup) {
                statusArea.innerHTML = '<p class="p-message error-message">Por favor, ingresa un grupo muscular o enfoque (Ej: Espalda).</p>';
                return;
            }

            statusArea.innerHTML = `<p class="loading-message">Generando rutina para: <strong>${muscleGroup}</strong>... üß†</p>`;
            
            const userQuery = `Genera una rutina de ejercicios de 3 a 5 ejercicios para el siguiente enfoque: ${muscleGroup}`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: ROUTINE_SYSTEM_INSTRUCTION }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: routineSchema
                }
            };

            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };

            try {
                const response = await exponentialBackoffFetch(GEMINI_BASE_URL, options);
                const result = await response.json();
                //console.log("Respuesta de Gemini para rutina estructurada:", result.rutina);
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (jsonText) {
                    const newExercises = JSON.parse(jsonText);
                    console.log("Ejercicios generados:", newExercises.rutina);
                    if (newExercises.rutina.length > 0) {
                        // 1. Obtener la rutina actual
                        const routineJSON = localStorage.getItem(ROUTINE_KEY);
                        let routine = routineJSON ? JSON.parse(routineJSON) : null;

                        if (!routine) {
                            // Si no hay rutina base, cargar la por defecto
                            cargarRutinasPorDefecto();
                            const defaultRoutineJSON = localStorage.getItem(ROUTINE_KEY);
                            routine = JSON.parse(defaultRoutineJSON);
                        }

                        // 2. Encontrar el d√≠a de hoy
                        const today = new Date();
                        const diaHoy = diasSemana[today.getDay()];
                        
                        let currentDayRoutine = routine.dias.find(d => d.dia === diaHoy);
                        
                        if (!currentDayRoutine) {
                            // Si el d√≠a de hoy no existe en la rutina (raro, pero posible en la default), lo creamos.
                            currentDayRoutine = { dia: diaHoy, enfoque: muscleGroup, duracion_sugerida_min: 45, ejercicios: [] };
                            routine.dias.push(currentDayRoutine);
                        }
                        
                        // 3. Actualizar enfoque y fusionar ejercicios
                        currentDayRoutine.enfoque = `${currentDayRoutine.enfoque} + ${muscleGroup} (IA)`;
                        currentDayRoutine.ejercicios = [...currentDayRoutine.ejercicios, ...newExercises.rutina];
                        
                        // 4. Guardar y Recargar
                        localStorage.setItem(ROUTINE_KEY, JSON.stringify(routine));
                        cargarRutinaEnAmbasTablas(routine);
                        
                        statusArea.innerHTML = `
                            <p class="success-message">üéâ Rutina generada y agregada a tu plan de ${diaHoy}!</p>
                            <p style="color: #e0e0e0;">Ve a la pesta√±a üóìÔ∏è Planeaci√≥n para ver los ${newExercises.length} nuevos ejercicios.</p>
                        `;

                    } else {
                        statusArea.innerHTML = '<p class="error-message">El Coach IA no pudo generar ejercicios. Intenta con un enfoque diferente.</p>';
                    }

                } else {
                    statusArea.innerHTML = '<p class="error-message">Error: La respuesta de Gemini no contiene datos JSON v√°lidos. Int√©ntalo de nuevo.</p>';
                }

            } catch (error) {
                console.error("Error al generar la rutina:", error);
                statusArea.innerHTML = '<p class="error-message">Ocurri√≥ un error de conexi√≥n o procesamiento. Revisa la consola.</p>';
            }
        }


        // Ejecutar funciones al cargar la p√°gina
        window.onload = function() {
            cargarFechaYHora();

            const routineData = localStorage.getItem(ROUTINE_KEY);
            if (routineData) {
                cargarRutinaEnAmbasTablas(JSON.parse(routineData));
            } else {
                cargarRutinasPorDefecto();
            }
            
            cargarBitacoraGuardada();
            
            // Asegura que al cargar la p√°gina, solo est√© visible la pesta√±a 'Registrar'
            showTab('registrar-tab', document.querySelector('.nav-bar button:nth-child(1)'));
        };

        /**
         * Verifica si la app tiene acceso real a internet.
         * Usa navigator.onLine como primera aproximaci√≥n y realiza un ping a https://www.gstatic.com/generate_204
         * para confirmar conectividad real (timeout 3s).
         * @param {boolean} forcePing - cuando true fuerza el ping incluso si navigator.onLine === false
         * @returns {Promise<boolean>}
         */
        async function checkOnlineStatus(forcePing = false) {
            const indicator = document.getElementById('online-indicator');
            const textEl = document.getElementById('online-text');

            // Si navigator.reportar offline y no forzamos, marcamos offline r√°pido
            if (!navigator.onLine && !forcePing) {
                setOffline();
                return false;
            }

            // Intento de ping r√°pido para confirmar acceso real
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 3000);

            try {
                const res = await fetch('https://studio--studio-9121294900-64a17.us-central1.hosted.app/api/hello', {
                    method: 'GET',
                    cache: 'no-store',
                    signal: controller.signal
                });
                clearTimeout(timeoutId);

                if (res && (res.status === 204 || res.ok)) {
                    setOnline();
                    return true;
                } else {
                    setOffline();
                    return false;
                }
            } catch (err) {
                clearTimeout(timeoutId);
                setOffline();
                return false;
            }

            // helpers locales
            function setOnline() {
                indicator.classList.remove('offline', 'hidden');
                indicator.querySelector('.dot').style.background = '#28a745';
                textEl.textContent = 'En l√≠nea';
                indicator.title = 'Conexi√≥n OK';
            }
            function setOffline() {
                indicator.classList.add('offline');
                indicator.classList.remove('hidden');
                indicator.querySelector('.dot').style.background = '#dc3545';
                textEl.textContent = 'Sin conexi√≥n';
                indicator.title = 'Sin acceso a Internet';
            }
        }

        // Manejo de eventos online/offline del navegador
        window.addEventListener('online', () => {
            // cuando regresa la se√±al, confirmamos con un ping
            checkOnlineStatus(true);
        });
        window.addEventListener('offline', () => {
            // cambio inmediato visual cuando el navegador detecta offline
            const indicator = document.getElementById('online-indicator');
            if (indicator) {
                indicator.classList.add('offline');
                indicator.querySelector('.dot').style.background = '#dc3545';
                document.getElementById('online-text').textContent = 'Sin conexi√≥n';
                indicator.title = 'Sin acceso a Internet';
            }
        });

        // Verificaci√≥n peri√≥dica cada 30s (por si navigator.onLine est√° true pero no hay acceso real)
        const ONLINE_CHECK_INTERVAL_MS = 30000;
        setInterval(() => {
            checkOnlineStatus();
        }, ONLINE_CHECK_INTERVAL_MS);

        // Llamada inicial al cargar
        window.addEventListener('load', () => {
            checkOnlineStatus();
        });
    </script>
</body>
</html>